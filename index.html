<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>客户服务中心</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <header>
        <h1>🚀 客服门户</h1>
        <div data-netlify-identity-button></div>
    </header>

    <main>
        <div id="auth-status" style="display:none;">
            <div>
                <img id="user-avatar" src="" class="avatar" style="display:none;">
                <span>欢迎回来，<strong id="user-name"></strong></span>
            </div>
            <div>
                <a href="/profile.html">账户设置</a> | 
                <span id="admin-link" style="display:none;"><a href="/admin.html">管理后台</a></span>
            </div>
        </div>

        <section>
            <h2>提交您的诉求</h2>
            <form name="contact" method="POST" action="/success.html" data-netlify="true">
                <input type="hidden" name="form-name" value="contact" />
                <p><label>您的姓名: <input type="text" name="name" id="form-name-input" required /></label></p>
                <p><label>您的邮箱: <input type="email" name="email" id="form-email-input" required /></label></p>
                <p><label>留言信息: <textarea name="message" rows="4" required></textarea></label></p>
                <button type="submit">立即发送</button>
            </form>
        </section>
    </main>

    <script>
        netlifyIdentity.init({ locale: 'zh' });

        function updateUI(user) {
            const statusDiv = document.getElementById('auth-status');
            const nameEl = document.getElementById('user-name');
            const adminEl = document.getElementById('admin-link');
            const avatarEl = document.getElementById('user-avatar');

            if (user) {
                statusDiv.style.display = 'flex';
                nameEl.innerText = user.user_metadata.full_name || "用户";
                
                // 自动填充表单
                document.getElementById('form-name-input').value = user.user_metadata.full_name || "";
                document.getElementById('form-email-input').value = user.email;

                // 显示头像
                if (user.user_metadata.avatar_url) {
                    avatarEl.src = user.user_metadata.avatar_url;
                    avatarEl.style.display = 'inline-block';
                }

                // 权限检查
                if (user.app_metadata.roles && user.app_metadata.roles.includes('admin')) {
                    adminEl.style.display = 'inline';
                }
            } else {
                statusDiv.style.display = 'none';
            }
        }

        netlifyIdentity.on('init', updateUI);
        netlifyIdentity.on('login', user => { updateUI(user); netlifyIdentity.close(); });
        netlifyIdentity.on('logout', () => location.reload());
    </script>
</body>
</html>