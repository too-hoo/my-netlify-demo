<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†å‘˜åå° - å®¢æœé—¨æˆ·</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>ğŸ›  ç®¡ç†å‘˜ä»ªè¡¨ç›˜</h1>
        <a href="/members.html">è¿”å›ä¼šå‘˜ä¸­å¿ƒ</a>
    </header>

    <main>
        <section class="container" style="margin-bottom: 30px;">
            <h3>ğŸ“ˆ ç•™è¨€è¶‹åŠ¿åˆ†æ</h3>
            <div style="height: 300px;">
                <canvas id="submissionsChart"></canvas>
            </div>
        </section>

        <section class="container">
            <h3>ğŸ’¬ å®¢æˆ·ç•™è¨€ç®¡ç†</h3>
            <div id="submission-list-container">
                <ul id="submission-list">æ­£åœ¨åŠ è½½ç•™è¨€...</ul>
                <button onclick="fetchSubmissions()" style="background: #666;">åˆ·æ–°åˆ—è¡¨</button>
            </div>
        </section>
    </main>
</body>
<script>
    // åœ¨ script æ ‡ç­¾çš„æœ€å¼€å§‹å¤„æ·»åŠ 
    // netlifyIdentity.init({locale: 'zh' });
</script>
<script>
    let myChart; // å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿åˆ·æ–°æ•°æ®

    // æ ¸å¿ƒï¼šäºŒæ¬¡é‰´æƒé€»è¾‘
    netlifyIdentity.on('init', user => {
        if (!user) {
            window.location.href = "/";
        } else {
            const roles = user.app_metadata.roles || [];
            if (!roles.includes("admin")) {
                alert("æŠ±æ­‰ï¼Œæ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼");
                window.location.href = "/members.html";
            } else {
                fetchSubmissions(); // åªæœ‰ç®¡ç†å‘˜æ‰è°ƒå– API
            }
        }
    });

    async function fetchSubmissions() {
        const listEl = document.getElementById('submission-list');
        try {
            // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å»ºç«‹çš„æ— æœåŠ¡å™¨å‡½æ•°
            const response = await fetch('/.netlify/functions/get-submissions');
            const data = await response.json();

            // 1. æ¸²æŸ“å›¾è¡¨
            renderChart(data);

            const latest = data.slice(0, 5); // åªæ˜¾ç¤ºæœ€è¿‘5æ¡
            
            listEl.innerHTML = latest.map(sub => {
                const { name, email, message } = sub.data;
                const date = new Date(sub.created_at).toLocaleString('zh-CN');
                
                return `
                    <li class="submission-card" id="sub-${sub.id}">
                        <div class="sub-header">
                            <span class="sub-name">ğŸ‘¤ ${name}</span>
                            <span>ğŸ“… ${date}</span>
                        </div>
                        <span class="sub-msg">ğŸ’¬ ${message}</span>
                        <a href="mailto:${email}?subject=å…³äºæ‚¨åœ¨ç«™ç‚¹çš„ç•™è¨€åé¦ˆ&body=æ‚¨å¥½ ${name}ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†æ‚¨çš„ç•™è¨€ï¼š'${message}'%0A%0A---%0Aæˆ‘ä»¬çš„å›å¤ï¼š" 
                        class="reply-btn">
                        ğŸ“© ä¸€é”®å›ä¿¡
                        </a>
                        <button onclick="deleteSubmission('${sub.id}')" class="delete-btn">ğŸ—‘ åˆ é™¤</button>
                    </li>
                `;
            }).join('') || '<li>ç›®å‰è¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•ç•™è¨€ã€‚</li>';
            
        } catch (err) {
            listEl.innerHTML = '<li style="color:red;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</li>';
        }
    }
    async function deleteSubmission(submissionId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;

        try {
            const response = await fetch('/.netlify/functions/delete-submission', {
                method: 'POST',
                body: JSON.stringify({ submissionId })
            });

            if (response.ok) {
                alert("åˆ é™¤æˆåŠŸï¼");
                // é‡æ–°åˆ·æ–°æ•°æ®ï¼Œå›¾è¡¨å’Œåˆ—è¡¨éƒ½ä¼šåŒæ­¥æ›´æ–°
                fetchSubmissions(); 
            } else {
                alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
            }
        } catch (err) {
            console.error("åˆ é™¤å‡ºé”™:", err);
        }
    }

    function renderChart(submissions) {
        const ctx = document.getElementById('submissionsChart').getContext('2d');
        
        // --- æ•°æ®å¤„ç†ï¼šç»Ÿè®¡æœ€è¿‘ 7 å¤©çš„ç•™è¨€æ•° ---
        const last7Days = [...Array(7)].map((_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - i);
            return d.toISOString().split('T')[0];
        }).reverse();

        const counts = last7Days.map(date => {
            // è¿‡æ»¤å‡ºæ—¥æœŸåŒ¹é…çš„ç•™è¨€
            return submissions.filter(s => s.created_at.startsWith(date)).length;
        });

        // --- é”€æ¯æ—§å›¾è¡¨ï¼ˆé˜²æ­¢åˆ·æ–°æ—¶é‡å ï¼‰ ---
        if (myChart) myChart.destroy();

        // --- åˆ›å»ºæ–°å›¾è¡¨ ---
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last7Days.map(d => d.slice(5)), // åªæ˜¾ç¤ºæœˆ-æ—¥
                datasets: [{
                    label: 'æ¯æ—¥ç•™è¨€è¶‹åŠ¿',
                    data: counts,
                    borderColor: '#00ad9f',
                    backgroundColor: 'rgba(0, 173, 159, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }
    // åœ¨èº«ä»½éªŒè¯æˆåŠŸåè§¦å‘
    netlifyIdentity.on('init', user => {
        if (!user) {
            window.location.href = "/";
        } else {
            const roles = user.app_metadata.roles || [];
            if (roles.includes("admin")) {
                document.getElementById('admin-tools').style.display = 'block';
                fetchSubmissions(); // ç®¡ç†å‘˜ç™»å½•åè‡ªåŠ¨æŠ“å–
            }
        }
    });
</script>
<script>
    // å¦‚æœç”¨æˆ·åœ¨å½“å‰é¡µç™»å‡ºï¼Œä¹Ÿè·³è½¬å›é¦–é¡µ
    netlifyIdentity.on('logout', () => {
        window.location.href = "/";
    });
</script>
<style>
    /* ç®¡ç†å‘˜å·¥å…·ç®±å®¹å™¨ */
    #admin-tools {
        display: none;
        background: #ffffff;
        border: 1px dashed #ff4d4f;
        border-radius: 12px;
        padding: 24px;
        margin-top: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* ç•™è¨€åˆ—è¡¨æ ·å¼ */
    #submission-list {
        list-style: none;
        padding: 0;
    }

    .submission-card {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #00ad9f;
        transition: transform 0.2s;
    }

    .submission-card:hover {
        transform: translateX(5px);
    }

    .sub-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9em;
        color: #888;
    }

    .sub-name {
        color: #333;
        font-weight: bold;
        font-size: 1.1em;
    }

    .sub-msg {
        display: block;
        margin: 10px 0;
        line-height: 1.5;
        color: #444;
    }

    /* å›ä¿¡æŒ‰é’®æ ·å¼ */
    .reply-btn {
        display: inline-block;
        padding: 6px 12px;
        background-color: #00ad9f;
        color: white !important;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.85em;
    }

    .reply-btn:hover {
        background-color: #008a7f;
    }

    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .delete-btn {
        display: inline-block;
        padding: 6px 12px;
        background-color: #ff4d4f;
        color: white !important;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.85em;
        border: none;
        cursor: pointer;
        margin-left: 10px;
    }

    .delete-btn:hover {
        background-color: #d9363e;
    }

    .btn-group {
        margin-top: 10px;
    }
</style>
</html>